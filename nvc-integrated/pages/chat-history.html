<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对话历史记录 - 非暴力沟通卡片系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="stylesheet" href="../assets/css/animations.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Markdown渲染 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.1.0/github-markdown.min.css">
    <!-- 代码高亮 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    
    <style>
        /* 历史记录卡片样式 */
        .history-card {
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            background-color: #fff;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: rgba(var(--bs-primary-rgb), 0.5);
        }
        
        .history-card-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .bot-type-badge {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            color: var(--bs-primary);
            font-weight: 500;
            margin-left: 8px;
            display: inline-block;
        }
        
        .history-card-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .history-question {
            font-weight: 500;
            margin-bottom: 12px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .history-answer {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            color: #555;
            margin-bottom: 10px;
            font-size: 0.9rem;
            flex-grow: 1;
        }
        
        .history-card-footer {
            padding: 10px 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
            background-color: #fcfcfc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .card-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .chat-timestamp {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* 机器人类型卡片标记样式 */
        .history-card.coach {
            border-top: 4px solid #4e73df;
        }
        
        .history-card.knowledge {
            border-top: 4px solid #36b9cc;
        }
        
        .history-card.conflict {
            border-top: 4px solid #f6c23e;
        }
        
        /* 展开全文按钮 */
        .expand-btn {
            font-size: 0.85rem;
            color: var(--bs-primary);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
        }
        
        .expand-btn:hover {
            text-decoration: underline;
        }
        
        /* 过滤工具栏 */
        .filter-toolbar {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        /* 搜索状态指示器 */
        .search-status {
            padding: 10px 15px;
            margin-bottom: 20px;
            background-color: #f0f8ff;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        /* 加载动画 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .btn-pulse {
            animation: pulse 2s infinite;
        }
        
        /* 模态框样式 */
        .chat-detail-modal .modal-header {
            border-bottom-width: 3px;
        }
        
        .chat-detail-modal.coach .modal-header {
            border-bottom-color: #4e73df;
        }
        
        .chat-detail-modal.knowledge .modal-header {
            border-bottom-color: #36b9cc;
        }
        
        .chat-detail-modal.conflict .modal-header {
            border-bottom-color: #f6c23e;
        }
        
        .chat-detail-content {
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px 0;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-comments me-2"></i>非暴力沟通卡片系统
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./elements.html">NVC要素</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./cases.html">案例卡片</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./practice.html">练习</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./chat-history.html">历史记录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./ai-assistant.html">AI助手</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 导航面包屑 -->
    <div class="container mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html">首页</a></li>
                <li class="breadcrumb-item active" aria-current="page">对话历史记录</li>
            </ol>
        </nav>
    </div>

    <!-- 页面主体内容 -->
    <div class="container my-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="fw-bold mb-0">对话历史记录</h1>
                <p class="text-secondary">查看、管理您与非暴力沟通AI助手的历史对话</p>
            </div>
            <div class="col-md-8 col-lg-9">
                <!-- 过滤选项 -->
                <div class="d-flex align-items-center flex-wrap gap-2 mb-3">
                    <div class="me-2">
                        <label for="filterBotType" class="form-label mb-0 me-1">按助手筛选:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="filterBotType">
                            <option value="all">全部助手</option>
                            <option value="非暴力沟通教练">非暴力沟通教练</option>
                            <option value="非暴力沟通知识库">非暴力沟通知识库</option>
                            <option value="非暴力沟通冲突拆解">非暴力沟通冲突拆解</option>
                        </select>
                    </div>
                    <div class="me-2">
                        <label for="sortOrder" class="form-label mb-0 me-1">排序:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="sortOrder">
                            <option value="newest">最新优先</option>
                            <option value="oldest">最早优先</option>
                        </select>
                    </div>
                    <div class="input-group input-group-sm w-auto ms-auto">
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索历史记录...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-lg-3 text-md-end mt-3 mt-md-0">
                <button id="clearAllBtn" class="btn btn-outline-danger">
                    <i class="fas fa-trash-alt me-1"></i>清空全部历史
                </button>
            </div>
        </div>

        <!-- 历史记录为空时显示 -->
        <div id="emptyHistory" class="text-center py-5 my-4 rounded shadow-sm bg-light d-none">
            <i class="fas fa-history fa-3x text-secondary mb-3"></i>
            <h3>暂无对话历史</h3>
            <p class="text-muted">当您与AI助手进行对话并保存后，对话记录将显示在这里</p>
            <a href="./ai-assistant.html" class="btn btn-primary mt-2">
                <i class="fas fa-comments me-1"></i>开始对话
            </a>
        </div>

        <!-- 历史记录网格布局 -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="history-container">
            <!-- 此处由JavaScript填充历史记录 -->
        </div>

        <!-- 加载更多按钮 -->
        <div class="text-center mt-4 d-none" id="loadMoreContainer">
            <button class="btn btn-outline-primary" id="loadMoreBtn">
                <i class="fas fa-chevron-down me-1"></i>加载更多
            </button>
        </div>
    </div>

    <!-- 在页脚前添加问问大象品牌展示区 -->
    <section class="py-5 bg-light bg-glow-secondary">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-7 fade-in-up">
                    <h2 class="text-gradient mb-4">由「问问大象主题学习」精心打造</h2>
                    <p class="lead">我们致力于通过创新的学习方法和工具，帮助更多人掌握非暴力沟通技巧，创造更和谐的人际关系。</p>
                    <p>问问大象主题学习团队将持续更新本系统，提供更多实用的NVC学习资源和练习工具，欢迎关注我们的最新动态。</p>
                    <!-- 添加互动元素 -->
                    <div class="mt-4 d-flex flex-wrap gap-3">
                        <div class="feature-badge glow-hover">
                            <i class="fas fa-heart text-danger me-2"></i>用爱驱动
                        </div>
                        <div class="feature-badge glow-hover">
                            <i class="fas fa-lightbulb text-warning me-2"></i>持续创新
                        </div>
                        <div class="feature-badge glow-hover">
                            <i class="fas fa-users text-primary me-2"></i>共同成长
                        </div>
                    </div>
                </div>
                <div class="col-md-5 text-center fade-in-up fade-in-up-delay-1">
                    <div class="mascot-container position-relative">
                        <!-- 气泡装饰 -->
                        <div class="speech-bubble">
                            嗨！一起学习<br>非暴力沟通吧！
                        </div>
                        <!-- 添加问问大象图片 -->
                        <img src="../mascot.jpg" 
                             onerror="this.onerror=null; this.src='https://b95b-static-xiang-6ghtoqfd66b1e958.static.cloud.tencent.com/mascot.jpg';" 
                             alt="问问大象吉祥物" class="img-fluid mascot-image" style="max-width: 80%; opacity: 0.85; transform: rotate(-5deg);">
                        <div class="mascot-shadow"></div>
                        <!-- 小装饰元素 -->
                        <div class="decoration-element decoration-1"></div>
                        <div class="decoration-element decoration-2"></div>
                        <div class="decoration-element decoration-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <style>
        /* 问问大象图片样式 */
        .mascot-container {
            padding: 20px;
            perspective: 1000px;
            position: relative;
            height: 350px;
        }
        
        .mascot-image {
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            filter: drop-shadow(0 5px 15px rgba(0, 123, 255, 0.2));
            position: relative;
            z-index: 2;
        }
        
        .mascot-image:hover {
            transform: rotate(0deg) scale(1.05);
            opacity: 1 !important;
        }
        
        .mascot-shadow {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 10px;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 70%);
            border-radius: 50%;
            animation: shadow 6s ease-in-out infinite;
            z-index: 1;
        }
        
        /* 语音气泡 */
        .speech-bubble {
            position: absolute;
            top: 10px;
            right: 15%;
            background-color: white;
            border-radius: 20px;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 3;
            animation: bounce 3s ease-in-out infinite;
            transform-origin: bottom left;
            color: #0d6efd;
        }
        
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 20px;
            border-width: 10px 10px 0;
            border-style: solid;
            border-color: white transparent;
        }
        
        /* 装饰元素 */
        .decoration-element {
            position: absolute;
            border-radius: 50%;
            opacity: 0.6;
            z-index: 1;
        }
        
        .decoration-1 {
            width: 25px;
            height: 25px;
            background-color: rgba(13, 110, 253, 0.3);
            top: 10%;
            left: 10%;
            animation: move1 8s infinite alternate;
        }
        
        .decoration-2 {
            width: 15px;
            height: 15px;
            background-color: rgba(253, 126, 20, 0.3);
            bottom: 20%;
            right: 15%;
            animation: move2 6s infinite alternate;
        }
        
        .decoration-3 {
            width: 20px;
            height: 20px;
            background-color: rgba(25, 135, 84, 0.3);
            bottom: 30%;
            left: 20%;
            animation: move3 7s infinite alternate;
        }
        
        .feature-badge {
            display: inline-flex;
            align-items: center;
            background-color: white;
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .feature-badge:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes float {
            0% { transform: translateY(0px) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(-2deg); }
            100% { transform: translateY(0px) rotate(-5deg); }
        }
        
        @keyframes shadow {
            0% { transform: translateX(-50%) scale(1); opacity: 0.4; }
            50% { transform: translateX(-50%) scale(0.85); opacity: 0.2; }
            100% { transform: translateX(-50%) scale(1); opacity: 0.4; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes move1 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(10px, 10px); }
        }
        
        @keyframes move2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-15px, -5px); }
        }
        
        @keyframes move3 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(8px, -12px); }
        }
    </style>

    <!-- 页脚 -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p>© <span id="currentYear">2025</span> 非暴力沟通卡片系统</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="#" class="text-decoration-none text-muted me-3">关于我们</a>
                    <a href="#" class="text-decoration-none text-muted me-3">使用条款</a>
                    <a href="#" class="text-decoration-none text-muted">隐私政策</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 添加署名 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5;">
        <p class="small text-muted mb-0" style="font-size: 0.85rem; opacity: 0.8;">Made by 问问大象主题学习</p>
    </div>

    <!-- 添加模态框 -->
    <div class="modal fade" id="chatDetailModal" tabindex="-1" aria-labelledby="chatDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered chat-detail-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatDetailModalLabel">对话详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="bot-type-badge" id="modalBotType">机器人类型</span>
                            <span class="text-muted ms-2" id="modalDate">日期时间</span>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>问题</strong>
                        </div>
                        <div class="card-body">
                            <p class="mb-0" id="modalQuestion"></p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <strong>回答</strong>
                        </div>
                        <div class="card-body chat-detail-content">
                            <div class="markdown-body" id="modalAnswer"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="modalCopyBtn">
                        <i class="far fa-copy me-1"></i>复制对话
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/auth.js"></script>
    
    <!-- 历史记录脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 设置年份
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // 获取DOM元素
            const historyContainer = document.getElementById('history-container');
            const emptyHistory = document.getElementById('emptyHistory');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const filterBotType = document.getElementById('filterBotType');
            const sortOrder = document.getElementById('sortOrder');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            
            // 模态框元素
            const chatDetailModal = new bootstrap.Modal(document.getElementById('chatDetailModal'));
            const modalBotType = document.getElementById('modalBotType');
            const modalDate = document.getElementById('modalDate');
            const modalQuestion = document.getElementById('modalQuestion');
            const modalAnswer = document.getElementById('modalAnswer');
            const modalCopyBtn = document.getElementById('modalCopyBtn');
            
            // 配置
            let currentPage = 1;
            const pageSize = 9;
            let filteredHistory = [];
            let currentFilter = "all";
            let currentSort = "newest";
            let currentSearch = "";
            
            // 初始化
            loadChatHistory();
            
            // Marked.js配置
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: function(code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, {language}).value;
                },
                langPrefix: 'hljs language-',
                breaks: true,
                gfm: true
            });
            
            // 加载历史记录
            function loadChatHistory() {
                try {
                    // 从localStorage获取历史记录
                    const chatHistory = JSON.parse(localStorage.getItem('nvcChatHistory') || '[]');
                    
                    // 如果没有历史记录，显示空状态
                    if (!chatHistory || chatHistory.length === 0) {
                        historyContainer.innerHTML = '';
                        emptyHistory.classList.remove('d-none');
                        return;
                    }
                    
                    // 隐藏空状态
                    emptyHistory.classList.add('d-none');
                    
                    // 应用过滤和排序
                    filterAndDisplayHistory(chatHistory);
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                    historyContainer.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                加载历史记录时出错: ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
            
            // 过滤和显示历史记录
            function filterAndDisplayHistory(chatHistory) {
                // 应用过滤
                filteredHistory = chatHistory.filter(chat => {
                    // 过滤机器人类型
                    if (currentFilter !== "all" && chat.botType !== currentFilter) {
                        return false;
                    }
                    
                    // 搜索过滤
                    if (currentSearch) {
                        const searchLower = currentSearch.toLowerCase();
                        return chat.question.toLowerCase().includes(searchLower) || 
                               chat.answer.toLowerCase().includes(searchLower);
                    }
                    
                    return true;
                });
                
                // 应用排序
                if (currentSort === "newest") {
                    filteredHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } else {
                    filteredHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                }
                
                // 清空容器
                historyContainer.innerHTML = '';
                
                // 分页显示
                const totalPages = Math.ceil(filteredHistory.length / pageSize);
                const start = 0;
                const end = Math.min(pageSize, filteredHistory.length);
                
                // 显示记录
                displayHistoryPage(start, end);
                
                // 显示/隐藏加载更多按钮
                if (totalPages > 1) {
                    loadMoreContainer.classList.remove('d-none');
                } else {
                    loadMoreContainer.classList.add('d-none');
                }
                
                // 搜索结果提示
                if (currentSearch) {
                    const searchStatusElem = document.createElement('div');
                    searchStatusElem.className = 'col-12 mb-3';
                    searchStatusElem.innerHTML = `
                        <div class="search-status">
                            <i class="fas fa-search me-2"></i>
                            搜索 "${currentSearch}" 的结果: ${filteredHistory.length} 条记录
                            ${filteredHistory.length === 0 ? 
                                '<p class="mb-0 mt-2 text-muted">尝试使用不同的关键词或清除过滤条件</p>' : ''}
                        </div>
                    `;
                    historyContainer.prepend(searchStatusElem);
                }
            }
            
            // 显示分页历史记录
            function displayHistoryPage(start, end) {
                const displayedHistory = filteredHistory.slice(start, end);
                
                if (displayedHistory.length === 0 && currentPage === 1) {
                    // 没有符合条件的记录
                    historyContainer.innerHTML += `
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h4>未找到符合条件的记录</h4>
                            <p class="text-muted">尝试调整过滤条件或搜索关键词</p>
                            <button class="btn btn-outline-primary mt-2" id="resetFiltersBtn">
                                <i class="fas fa-redo me-1"></i>重置所有过滤
                            </button>
                        </div>
                    `;
                    
                    // 绑定重置按钮事件
                    document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
                    return;
                }
                
                // 遍历并显示记录
                displayedHistory.forEach((chat, index) => {
                    // 创建历史记录卡片
                    const chatCard = createHistoryCard(chat, start + index);
                    historyContainer.appendChild(chatCard);
                });
                
                // 初始化高亮代码块
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
            
            // 创建历史记录卡片
            function createHistoryCard(chat, index) {
                const chatDate = new Date(chat.timestamp);
                const formattedDate = formatDate(chatDate);
                
                // 确定卡片类型
                let cardTypeClass = '';
                if (chat.botType === '非暴力沟通教练') {
                    cardTypeClass = 'coach';
                } else if (chat.botType === '非暴力沟通知识库') {
                    cardTypeClass = 'knowledge';
                } else if (chat.botType === '非暴力沟通冲突拆解') {
                    cardTypeClass = 'conflict';
                }
                
                // 创建卡片列
                const cardCol = document.createElement('div');
                cardCol.className = 'col';
                
                // 构建卡片内容
                cardCol.innerHTML = `
                    <div class="history-card ${cardTypeClass}" data-index="${index}">
                        <div class="history-card-header">
                            <div>
                                <i class="fas fa-comment-dots me-1"></i>
                                <span class="fw-bold">对话 #${index + 1}</span>
                                <span class="bot-type-badge">${chat.botType}</span>
                            </div>
                            <span class="chat-timestamp"><i class="far fa-clock me-1"></i>${formattedDate}</span>
                        </div>
                        <div class="history-card-body">
                            <div class="card-label">问题</div>
                            <p class="history-question">${chat.question}</p>
                            <div class="card-label">回答</div>
                            <div class="history-answer">${chat.answer}</div>
                            <button class="expand-btn mt-1">
                                <i class="fas fa-expand-alt me-1"></i>查看完整对话
                            </button>
                        </div>
                        <div class="history-card-footer">
                            <div class="history-card-actions">
                                <button class="btn btn-sm btn-outline-primary copy-btn" data-index="${index}">
                                    <i class="far fa-copy"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${index}">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加事件监听器
                setTimeout(() => {
                    const card = cardCol.querySelector('.history-card');
                    const expandBtn = card.querySelector('.expand-btn');
                    const copyBtn = card.querySelector('.copy-btn');
                    const deleteBtn = card.querySelector('.delete-btn');
                    
                    // 展开按钮 - 打开模态框
                    expandBtn.addEventListener('click', () => {
                        showChatDetail(chat, cardTypeClass);
                    });
                    
                    // 卡片点击 - 打开模态框
                    card.addEventListener('click', (e) => {
                        // 排除点击操作按钮的情况
                        if (!e.target.closest('.copy-btn') && !e.target.closest('.delete-btn')) {
                            showChatDetail(chat, cardTypeClass);
                        }
                    });
                    
                    // 复制按钮
                    copyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        copyChat(chat);
                    });
                    
                    // 删除按钮
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteChat(index);
                    });
                }, 0);
                
                return cardCol;
            }
            
            // 显示对话详情
            function showChatDetail(chat, cardTypeClass) {
                // 设置模态框内容
                modalBotType.textContent = chat.botType;
                modalDate.textContent = formatDate(new Date(chat.timestamp));
                modalQuestion.textContent = chat.question;
                modalAnswer.innerHTML = marked.parse(chat.answer);
                
                // 设置模态框样式
                document.querySelector('.chat-detail-modal').className = 
                    'modal-dialog modal-lg modal-dialog-centered chat-detail-modal ' + cardTypeClass;
                
                // 高亮代码块
                document.querySelectorAll('#modalAnswer pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
                
                // 设置复制按钮事件
                modalCopyBtn.onclick = () => {
                    copyChat(chat);
                };
                
                // 显示模态框
                chatDetailModal.show();
            }
            
            // 删除单条历史记录
            function deleteChat(index) {
                try {
                    // 显示确认对话框
                    if (!confirm('确定要删除这条对话记录吗？此操作不可撤销。')) {
                        return;
                    }
                    
                    // 获取原始历史记录
                    const chatHistory = JSON.parse(localStorage.getItem('nvcChatHistory') || '[]');
                    
                    // 在过滤后的数组中找到对应的聊天记录
                    const chatToDelete = filteredHistory[index];
                    
                    // 在原始数组中查找并删除
                    const originalIndex = chatHistory.findIndex(chat => 
                        chat.timestamp === chatToDelete.timestamp && 
                        chat.question === chatToDelete.question
                    );
                    
                    if (originalIndex !== -1) {
                        chatHistory.splice(originalIndex, 1);
                        
                        // 保存回localStorage
                        localStorage.setItem('nvcChatHistory', JSON.stringify(chatHistory));
                        
                        // 重新加载历史记录
                        currentPage = 1;
                        loadChatHistory();
                        
                        // 显示成功提示
                        showAlert('success', '历史记录已删除');
                    } else {
                        showAlert('danger', '未找到要删除的记录');
                    }
                } catch (error) {
                    console.error('删除历史记录失败:', error);
                    showAlert('danger', `删除失败: ${error.message}`);
                }
            }
            
            // 复制对话内容
            function copyChat(chat) {
                try {
                    // 构建要复制的文本
                    const textToCopy = `问题: ${chat.question}\n\n回答: ${chat.answer}`;
                    
                    // 复制到剪贴板
                    navigator.clipboard.writeText(textToCopy).then(
                        function() {
                            showAlert('success', '对话内容已复制到剪贴板');
                        }, 
                        function(err) {
                            console.error('复制失败:', err);
                            
                            // 备用方法：创建临时textarea
                            const textArea = document.createElement('textarea');
                            textArea.value = textToCopy;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            showAlert('success', '对话内容已复制到剪贴板');
                        }
                    );
                } catch (error) {
                    console.error('复制失败:', error);
                    showAlert('danger', `复制失败: ${error.message}`);
                }
            }
            
            // 清空所有历史记录
            clearAllBtn.addEventListener('click', function() {
                try {
                    // 显示确认对话框
                    if (!confirm('确定要清空所有对话历史记录吗？此操作不可撤销。')) {
                        return;
                    }
                    
                    // 清空历史记录
                    localStorage.setItem('nvcChatHistory', '[]');
                    
                    // 重新加载历史记录
                    loadChatHistory();
                    
                    // 显示成功提示
                    showAlert('success', '所有历史记录已清空');
                } catch (error) {
                    console.error('清空历史记录失败:', error);
                    showAlert('danger', `清空失败: ${error.message}`);
                }
            });
            
            // 过滤器变化事件
            filterBotType.addEventListener('change', function() {
                currentFilter = this.value;
                currentPage = 1;
                loadChatHistory();
            });
            
            // 排序变化事件
            sortOrder.addEventListener('change', function() {
                currentSort = this.value;
                currentPage = 1;
                loadChatHistory();
            });
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                currentSearch = searchInput.value.trim();
                currentPage = 1;
                loadChatHistory();
            });
            
            // 搜索输入框回车事件
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    currentSearch = searchInput.value.trim();
                    currentPage = 1;
                    loadChatHistory();
                }
            });
            
            // 加载更多按钮点击事件
            loadMoreBtn.addEventListener('click', function() {
                currentPage++;
                const start = (currentPage - 1) * pageSize;
                const end = Math.min(start + pageSize, filteredHistory.length);
                
                displayHistoryPage(start, end);
                
                // 如果已经加载了所有记录，隐藏按钮
                if (end >= filteredHistory.length) {
                    loadMoreContainer.classList.add('d-none');
                }
            });
            
            // 重置过滤器
            function resetFilters() {
                currentFilter = "all";
                currentSort = "newest";
                currentSearch = "";
                currentPage = 1;
                
                // 重置表单
                filterBotType.value = "all";
                sortOrder.value = "newest";
                searchInput.value = "";
                
                // 重新加载
                loadChatHistory();
            }
            
            // 格式化日期
            function formatDate(date) {
                return date.toLocaleString('zh-CN', {
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
            }
            
            // 显示提示
            function showAlert(type, message) {
                // 创建提示元素
                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3`;
                alert.setAttribute('role', 'alert');
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // 添加到页面
                document.body.appendChild(alert);
                
                // 3秒后自动消失
                setTimeout(() => {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 150);
                }, 3000);
            }
        });
    </script>
</body>
</html>
