# 腾讯云部署指南

本指南将帮助您在腾讯云上部署非暴力沟通AI助手，包括静态网站部署和云函数代理服务部署。

## 目录
1. [部署静态网站](#部署静态网站)
2. [部署云函数代理](#部署云函数代理)
3. [连接前端与代理](#连接前端与代理)
4. [域名和HTTPS配置](#域名和https配置)
5. [常见问题排查](#常见问题排查)

## 部署静态网站

### 使用腾讯云对象存储(COS)部署

1. **登录腾讯云控制台**：
   - 访问 https://console.cloud.tencent.com/ 并登录

2. **创建存储桶**：
   - 进入对象存储菜单
   - 点击"创建存储桶"
   - 设置存储桶名称（如`nvc-assistant`）
   - 选择合适的地域（建议选择离用户较近的地域）
   - 访问权限设置为"公有读私有写"
   - 其他设置保持默认，点击"创建"

3. **启用静态网站功能**：
   - 进入新创建的存储桶
   - 在左侧菜单选择"基础配置"
   - 找到"静态网站"设置，点击"编辑"
   - 启用静态网站功能
   - 设置默认首页为`index.html`
   - 点击"保存"

4. **上传文件**：
   - 在左侧菜单选择"文件列表"
   - 点击"上传文件"
   - 选择`index.html`文件上传
   - 如有其他资源文件，一并上传

5. **获取网站链接**：
   - 回到"基础配置"
   - 在静态网站设置部分，找到"访问节点"
   - 这个URL就是您的网站地址

## 部署云函数代理

### 创建云函数并部署代理服务

1. **进入云函数控制台**：
   - 在腾讯云控制台首页找到"云函数"或访问 https://console.cloud.tencent.com/scf/

2. **创建云函数**：
   - 点击"新建"按钮
   - 选择"从头开始"
   - 配置基础信息：
     - 函数名称：`coze-api-proxy`（可自定义）
     - 运行环境：Node.js 14.18（或更高版本）
     - 提交方法：行内编辑

3. **配置函数代码**：
   - 创建两个文件：
     - `index.js`：将我们的`proxy.js`内容粘贴到这里
     - `package.json`：将我们的package.json内容粘贴到这里

4. **配置触发器**：
   - 触发方式选择"API网关触发器"
   - 勾选"启用集成响应"
   - 访问权限选择"公共读写"
   - 其他保持默认

5. **配置环境变量（可选）**：
   - 如果您希望通过环境变量管理API密钥，可以添加环境变量
   - 例如添加`COZE_API_KEY`环境变量

6. **完成创建**：
   - 点击"完成"按钮创建函数

7. **测试函数**：
   - 创建完成后，可以点击"部署"确保最新代码已部署
   - 使用测试功能，模拟API网关触发，检查函数是否正常工作

### 查看API网关信息

1. **查找服务信息**：
   - 在函数详情页，找到"触发管理"选项卡
   - 点击API网关触发器的"API服务名"链接，跳转到API网关控制台
   - 记录下"公网访问地址"，这是您的代理服务URL

2. **配置响应集成（如果需要）**：
   - 在API网关控制台，选择对应的API服务
   - 点击"编辑"
   - 确保"启用响应集成"已勾选
   - 保存修改

## 连接前端与代理

### 修改前端代码使用代理服务

1. **下载并编辑index.html**：
   - 下载部署在COS上的index.html文件
   - 找到API URL配置部分（约第1068行）：
     ```javascript
     const API_URL = "https://api.coze.cn/v3/chat";
     ```
   - 修改为您的云函数URL：
     ```javascript
     const API_URL = "https://您的API网关URL/coze-api-proxy";
     ```

2. **重新上传文件**：
   - 将修改后的index.html上传回COS，覆盖原文件

3. **刷新浏览器测试**：
   - 访问您的静态网站URL
   - 发送测试消息，确认代理正常工作

## 域名和HTTPS配置

### 使用自定义域名（可选）

1. **域名准备**：
   - 确保您有已备案的域名（中国大陆地区必须备案）

2. **为静态网站配置域名**：
   - 在COS控制台中，选择您的存储桶
   - 点击"域名管理"
   - 添加自定义CDN加速域名
   - 按照向导完成配置

3. **为API网关配置域名**：
   - 在API网关控制台中，选择"自定义域名"
   - 添加您的域名
   - 配置SSL证书
   - 更新DNS记录，将您的域名指向API网关

4. **更新前端代码**：
   - 更新API URL为您的自定义域名
   - 重新部署前端代码

## 常见问题排查

### 静态网站问题

1. **网站无法访问**：
   - 确认存储桶权限设置为"公有读私有写"
   - 检查静态网站功能是否已启用
   - 验证index.html是否成功上传

2. **资源加载失败**：
   - 检查COS中的文件路径是否与代码中引用的路径一致
   - 确认所有外部资源（如CDN链接）是可访问的

### 云函数问题

1. **函数调用失败**：
   - 检查云函数日志，查看具体错误信息
   - 确保node-fetch依赖已正确安装
   - 验证入口函数名称与代码匹配

2. **CORS错误**：
   - 确认响应头中包含了正确的CORS设置
   - 检查API网关是否已启用集成响应
   - 验证前端请求中是否包含必要的头信息

3. **代理超时**：
   - 考虑增加云函数的超时设置
   - 检查Coze API的响应时间是否过长

### API网关问题

1. **404错误**：
   - 确认API网关的路径配置正确
   - 验证访问地址是完整的

2. **认证失败**：
   - 检查Authorization头是否正确传递
   - 确认Coze API密钥有效且未过期

---

如有进一步问题，请参考腾讯云官方文档：
- [对象存储文档](https://cloud.tencent.com/document/product/436)
- [云函数文档](https://cloud.tencent.com/document/product/583)
- [API网关文档](https://cloud.tencent.com/document/product/628) 