<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>非暴力沟通 AI 助手</title>
    <!-- 引入Marked.js库用于解析Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <!-- 引入代码高亮库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/highlight.min.js"></script>
    <style>
        /* 整体样式 - 苹果风格设计 */
        body {
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, 
                Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
        }

        .container {
            background-color: white;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #1d1d1f;
            text-align: center;
        }

        /* 输入区域样式 */
        .input-section {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            border-color: #0071e3;
            outline: none;
        }

        button {
            background-color: #0071e3;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0077ed;
        }

        button:disabled {
            background-color: #a1a1a6;
            cursor: not-allowed;
        }

        /* 响应区域样式 */
        .response-section {
            margin-top: 24px;
        }

        #response-container {
            background-color: #f5f5f7;
            border-radius: 10px;
            padding: 16px;
            min-height: 200px;
            overflow-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Markdown样式美化 */
        .markdown-body {
            color: #1d1d1f;
        }

        .markdown-body h1, 
        .markdown-body h2, 
        .markdown-body h3, 
        .markdown-body h4, 
        .markdown-body h5, 
        .markdown-body h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        .markdown-body h1 {
            font-size: 1.8em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }

        .markdown-body h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }

        .markdown-body p {
            margin-top: 0;
            margin-bottom: 16px;
        }

        .markdown-body ul, 
        .markdown-body ol {
            padding-left: 2em;
            margin-top: 0;
            margin-bottom: 16px;
        }

        .markdown-body blockquote {
            margin: 0;
            padding: 0 1em;
            color: #6a737d;
            border-left: 3px solid #dfe2e5;
        }

        .markdown-body pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
        }

        .markdown-body code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(27,31,35,0.05);
            border-radius: 3px;
        }

        .markdown-body pre > code {
            padding: 0;
            margin: 0;
            font-size: 100%;
            word-break: normal;
            white-space: pre;
            background: transparent;
            border: 0;
        }

        .markdown-body table {
            display: block;
            width: 100%;
            overflow: auto;
            border-spacing: 0;
            border-collapse: collapse;
        }

        .markdown-body table th {
            font-weight: 600;
            padding: 6px 13px;
            border: 1px solid #dfe2e5;
        }

        .markdown-body table td {
            padding: 6px 13px;
            border: 1px solid #dfe2e5;
        }

        .markdown-body table tr {
            background-color: #fff;
            border-top: 1px solid #c6cbd1;
        }

        .markdown-body table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }

        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #6e6e73;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #d2d2d7;
            border-radius: 50%;
            border-top-color: #0071e3;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* 调试区域 */
        .debug-section {
            margin-top: 20px;
            border-top: 1px solid #d2d2d7;
            padding-top: 16px;
            display: none;
        }

        .debug-toggle {
            background: none;
            border: none;
            color: #6e6e73;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
            padding: 0;
            margin-top: 8px;
        }

        .debug-log {
            background-color: #f2f2f7;
            border-radius: 6px;
            padding: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 8px;
        }

        .method-select {
            display: flex;
            margin-bottom: 16px;
            gap: 12px;
        }

        .method-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .method-option input {
            margin-right: 6px;
        }

        /* 原始数据显示 */
        .raw-data {
            margin-top: 8px;
            font-family: monospace;
            font-size: 12px;
            padding: 8px;
            background-color: #f2f2f7;
            border-radius: 6px;
            max-height: 80px;
            overflow-y: auto;
            display: none;
        }

        /* 机器人选择样式 */
        .bot-select {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f5f5f7;
            border-radius: 10px;
        }

        .bot-select select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
        }

        .bot-select select:focus {
            border-color: #0071e3;
            outline: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>非暴力沟通 AI 助手</h1>
        
        <div class="bot-select">
            <label for="bot-select">选择助手:</label>
            <select id="bot-select">
                <option value="7483330179063087138">非暴力沟通教练</option>
                <option value="7488916378381402131">非暴力沟通知识库</option>
            </select>
        </div>
        
        <div class="input-section">
            <div class="method-select">
                <label class="method-option">
                    <input type="radio" name="method" value="direct" checked> 直接请求API
                </label>
                <label class="method-option">
                    <input type="radio" name="method" value="corsanywhere"> 使用CORS代理
                </label>
            </div>
            
            <label for="user-input">输入你的问题:</label>
            <textarea id="user-input" placeholder="例如: 请介绍一下非暴力沟通的四个要素"></textarea>
            <div style="margin-top: 16px; text-align: center;">
                <button id="send-button">发送请求</button>
            </div>
        </div>
        
        <div class="response-section">
            <label>AI 回复:</label>
            <div id="response-container" class="markdown-body">等待发送请求...</div>
            <div id="status" class="status"></div>
            <div id="raw-data" class="raw-data"></div>
            <button class="debug-toggle" id="debug-toggle">显示调试信息</button>
            
            <div class="debug-section" id="debug-section">
                <div class="debug-log" id="debug-log"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const responseContainer = document.getElementById('response-container');
            const statusDiv = document.getElementById('status');
            const debugToggle = document.getElementById('debug-toggle');
            const debugSection = document.getElementById('debug-section');
            const debugLog = document.getElementById('debug-log');
            const rawDataDiv = document.getElementById('raw-data');
            const botSelect = document.getElementById('bot-select');

            // 设置默认示例问题
            userInput.value = "请介绍一下非暴力沟通的四个要素";

            // 配置Marked选项
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: function(code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-',
                pedantic: false,
                gfm: true,
                breaks: true,
                sanitize: false,
                smartypants: false,
                xhtml: false
            });

            // 将文本渲染为Markdown
            function renderMarkdown(text) {
                try {
                    return marked.parse(text);
                } catch (e) {
                    console.error('Markdown渲染出错:', e);
                    return text; // 如果渲染失败，返回原始文本
                }
            }

            // 更新响应容器，渲染Markdown
            function updateResponseWithMarkdown(text) {
                responseContainer.innerHTML = renderMarkdown(text);
                
                // 代码高亮
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }

            // 调试日志函数
            function logDebug(message, data) {
                const timestamp = new Date().toLocaleTimeString();
                let logEntry = document.createElement('div');
                
                if (typeof data === 'undefined') {
                    logEntry.textContent = `[${timestamp}] ${message}`;
                } else {
                    logEntry.textContent = `[${timestamp}] ${message}: ${typeof data === 'object' ? JSON.stringify(data) : data}`;
                }
                
                debugLog.appendChild(logEntry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }

            // 显示/隐藏调试信息
            debugToggle.addEventListener('click', function() {
                if (debugSection.style.display === 'none' || debugSection.style.display === '') {
                    debugSection.style.display = 'block';
                    debugToggle.textContent = '隐藏调试信息';
                } else {
                    debugSection.style.display = 'none';
                    debugToggle.textContent = '显示调试信息';
                }
            });

            // 显示原始数据
            function showRawData(data) {
                rawDataDiv.textContent = data;
                rawDataDiv.style.display = 'block';
            }
            
            // 当机器人选择改变时，更新页面提示信息
            botSelect.addEventListener('change', function() {
                const selectedOption = botSelect.options[botSelect.selectedIndex];
                const botType = selectedOption.textContent;
                
                // 更新默认问题提示
                if (botType === "非暴力沟通教练") {
                    userInput.placeholder = "例如: 请帮我分析一个冲突情境并提供非暴力沟通的建议";
                } else if (botType === "非暴力沟通知识库") {
                    userInput.placeholder = "例如: 请介绍一下非暴力沟通的四个要素";
                }
            });

            sendButton.addEventListener('click', async function() {
                // 获取用户输入
                const userMessage = userInput.value.trim();
                
                if (!userMessage) {
                    alert('请输入内容后再发送');
                    return;
                }

                // 获取选择的机器人ID
                const selectedBotId = botSelect.value;
                const selectedBotType = botSelect.options[botSelect.selectedIndex].textContent;
                
                // 获取选择的请求方式
                const methodRadios = document.querySelectorAll('input[name="method"]');
                let selectedMethod = 'direct';
                for (const radio of methodRadios) {
                    if (radio.checked) {
                        selectedMethod = radio.value;
                        break;
                    }
                }

                // 禁用发送按钮，显示加载状态
                sendButton.disabled = true;
                responseContainer.innerHTML = "";
                statusDiv.innerHTML = `<span class="loading"></span>正在等待 ${selectedBotType} 回复...`;
                debugLog.innerHTML = ''; // 清空调试日志
                rawDataDiv.style.display = 'none'; // 隐藏原始数据
                
                // 自动显示调试信息，方便查看问题
                debugSection.style.display = 'block';
                debugToggle.textContent = '隐藏调试信息';

                // API URLs
                const API_URL = "https://api.coze.cn/v3/chat";
                // 使用不同的CORS代理，因为cors-anywhere可能有限制
                const CORS_PROXY = "https://corsproxy.io/?";
                
                // 根据选择的方法决定URL
                const requestUrl = selectedMethod === 'direct' ? API_URL : CORS_PROXY + encodeURIComponent(API_URL);

                try {
                    // 准备要发送的数据
                    const requestData = {
                        bot_id: selectedBotId,
                        user_id: "123456789",
                        stream: true,
                        auto_save_history: true,
                        additional_messages: [
                            {
                                role: "user",
                                content: userMessage,
                                content_type: "text"
                            }
                        ]
                    };

                    logDebug("发送请求到", requestUrl);
                    logDebug("请求数据", requestData);

                    // 发起 fetch 请求
                    const response = await fetch(requestUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer pat_Fl4a5XU7dGl8Oy7RzkaGQAYouQ3a46CqhIo16AOpPvKxP2WQDJpjdrsVk6aRK2sC',
                            'Content-Type': 'application/json',
                            'Accept': 'text/event-stream'
                        },
                        body: JSON.stringify(requestData)
                    });

                    logDebug("收到响应状态", response.status + " " + response.statusText);
                    logDebug("响应头", JSON.stringify(Object.fromEntries([...response.headers])));
                    
                    if (!response.ok) {
                        throw new Error(`API错误: ${response.status} ${response.statusText}`);
                    }

                    if (!response.body) {
                        throw new Error('你的浏览器不支持流式响应');
                    }

                    // 处理流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = '';
                    let buffer = ''; // 用于处理不完整的数据块
                    let allChunks = ''; // 保存所有接收到的数据

                    while (true) {
                        const { done, value } = await reader.read();
                        
                        if (done) {
                            logDebug("数据流结束");
                            break;
                        }
                        
                        // 解码接收到的数据
                        const chunk = decoder.decode(value, { stream: true });
                        allChunks += chunk; // 收集所有数据块
                        logDebug("接收到数据块 (长度: " + chunk.length + ")", chunk);
                        buffer += chunk;
                        
                        // 显示接收到的原始数据以便调试
                        showRawData(allChunks);

                        /* 
                           Coze API可能使用的是SSE格式 (Server-Sent Events)
                           规范格式如下:
                           event: eventType
                           data: eventData

                           或者它可能使用的是自定义格式，我们尝试各种解析方法
                        */

                        // 试图从buffer中提取会话内容
                        extractContent(buffer);
                    }

                    // 处理最后可能剩余的数据
                    if (buffer.trim()) {
                        extractContent(buffer, true);
                    }

                    // 尝试从SSE格式、JSON或纯文本中提取内容
                    function extractContent(data, isLast = false) {
                        if (!data || data.trim() === '') return;

                        // 1. 尝试按照SSE格式解析（event/data对）
                        const events = parseSSE(data);
                        if (events.length > 0) {
                            // 成功解析为SSE格式
                            logDebug("检测到SSE格式事件数量", events.length);
                            
                            for (const event of events) {
                                logDebug("处理SSE事件", JSON.stringify(event));
                                
                                if (event.data) {
                                    try {
                                        // 尝试将data解析为JSON
                                        const jsonData = JSON.parse(event.data);
                                        logDebug("解析SSE数据为JSON", jsonData);
                                        
                                        // 尝试提取内容 - Coze可能使用的格式
                                        if (jsonData.data && jsonData.data.delta && jsonData.data.delta.content) {
                                            fullText += jsonData.data.delta.content;
                                            updateResponseWithMarkdown(fullText);
                                            logDebug("从SSE数据的delta.content中提取内容", jsonData.data.delta.content);
                                        }
                                        // OpenAI格式
                                        else if (jsonData.choices && jsonData.choices[0]) {
                                            if (jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
                                                fullText += jsonData.choices[0].delta.content;
                                                updateResponseWithMarkdown(fullText);
                                                logDebug("从OpenAI格式中提取内容", jsonData.choices[0].delta.content);
                                            }
                                        }
                                        // 其他可能的JSON格式
                                        else if (jsonData.content) {
                                            fullText += jsonData.content;
                                            updateResponseWithMarkdown(fullText);
                                            logDebug("从content字段提取内容", jsonData.content);
                                        }
                                        else if (jsonData.text) {
                                            fullText += jsonData.text;
                                            updateResponseWithMarkdown(fullText);
                                            logDebug("从text字段提取内容", jsonData.text);
                                        }
                                        // 简单情况：整个data内容就是要显示的文本
                                        else if (typeof jsonData === 'string') {
                                            fullText += jsonData;
                                            updateResponseWithMarkdown(fullText);
                                            logDebug("将整个JSON字符串作为内容", jsonData);
                                        }
                                    } catch (e) {
                                        // 如果不是有效的JSON，可能data本身就是文本内容
                                        logDebug("SSE数据不是有效JSON，尝试作为纯文本", event.data);
                                        fullText += event.data;
                                        updateResponseWithMarkdown(fullText);
                                    }
                                }
                            }
                            
                            // 更新buffer，移除已处理的部分
                            const lastEventEnd = data.lastIndexOf("\n\n");
                            if (lastEventEnd > -1 && !isLast) {
                                buffer = data.substring(lastEventEnd + 2);
                            } else if (isLast) {
                                buffer = '';
                            }
                            
                            return true;
                        }
                        
                        // 2. 如果不是SSE格式，尝试直接解析JSON (整个buffer作为一个JSON对象)
                        try {
                            const json = JSON.parse(data);
                            logDebug("整个数据块解析为单个JSON", json);
                            
                            // 处理可能的JSON格式
                            if (json.data && json.data.delta && json.data.delta.content) {
                                fullText += json.data.delta.content;
                                updateResponseWithMarkdown(fullText);
                                logDebug("从JSON中提取delta.content", json.data.delta.content);
                                buffer = '';
                                return true;
                            }
                            else if (json.text || json.content) {
                                const content = json.text || json.content;
                                fullText += content;
                                updateResponseWithMarkdown(fullText);
                                logDebug("从JSON中提取text/content", content);
                                buffer = '';
                                return true;
                            }
                        } catch (e) {
                            logDebug("不是单个JSON对象", e.message);
                        }
                        
                        // 3. 尝试逐行解析JSON
                        const lines = data.split("\n").filter(line => line.trim());
                        let foundContent = false;
                        
                        for (const line of lines) {
                            try {
                                const json = JSON.parse(line);
                                logDebug("逐行JSON解析成功", json);
                                
                                // 检查常见的JSON模式
                                if (json.event && json.data) {
                                    // 事件类型的JSON
                                    logDebug("检测到事件类型JSON", {event: json.event, data: json.data});
                                    
                                    // 检查是否是文本内容事件
                                    if (json.event === "conversation.message.delta") {
                                        try {
                                            const dataObj = typeof json.data === 'string' ? JSON.parse(json.data) : json.data;
                                            if (dataObj.delta && dataObj.delta.content) {
                                                fullText += dataObj.delta.content;
                                                updateResponseWithMarkdown(fullText);
                                                logDebug("从conversation.message.delta事件提取内容", dataObj.delta.content);
                                                foundContent = true;
                                            }
                                        } catch (e) {
                                            logDebug("解析delta事件数据失败", e.message);
                                        }
                                    }
                                }
                                // 直接检查是否有内容相关字段
                                else if (json.delta && json.delta.content) {
                                    fullText += json.delta.content;
                                    updateResponseWithMarkdown(fullText);
                                    logDebug("从delta.content字段提取内容", json.delta.content);
                                    foundContent = true;
                                }
                                else if (json.content) {
                                    fullText += json.content;
                                    updateResponseWithMarkdown(fullText);
                                    logDebug("从content字段提取内容", json.content);
                                    foundContent = true;
                                }
                            } catch (e) {
                                // 不是有效的JSON行，忽略
                            }
                        }
                        
                        if (foundContent) {
                            buffer = '';
                            return true;
                        }
                        
                        // 4. 最后尝试，检查是否包含纯文本回复
                        // 有些API可能直接返回文本而不是JSON或SSE格式
                        if (isLast && data.trim()) {
                            logDebug("将整个响应作为纯文本处理", data);
                            fullText = data.trim();
                            updateResponseWithMarkdown(fullText);
                            buffer = '';
                            return true;
                        }
                        
                        return false;
                    }
                    
                    // 解析SSE格式数据
                    function parseSSE(data) {
                        if (!data.includes('event:') && !data.includes('data:')) {
                            return [];
                        }
                        
                        const events = [];
                        const eventChunks = data.split('\n\n');
                        
                        for (const chunk of eventChunks) {
                            if (!chunk.trim()) continue;
                            
                            const event = {};
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('event:')) {
                                    event.event = line.substring(6).trim();
                                } else if (line.startsWith('data:')) {
                                    event.data = line.substring(5).trim();
                                } else if (line.startsWith('id:')) {
                                    event.id = line.substring(3).trim();
                                }
                            }
                            
                            if (Object.keys(event).length > 0) {
                                events.push(event);
                            }
                        }
                        
                        return events;
                    }
                    
                    // Coze API响应完成
                    statusDiv.textContent = `${selectedBotType} 回复完成`;
                    
                    // 如果到这里还没有内容，最后尝试解析整个收集到的数据
                    if (!fullText && allChunks) {
                        logDebug("尝试解析完整响应", allChunks);
                        extractContent(allChunks, true);
                    }
                    
                    // 最后的验证：如果处理后仍然没有内容，则显示错误信息
                    if (!fullText) {
                        responseContainer.innerHTML = "无法解析API返回的内容。请查看调试信息，了解返回的原始数据。";
                    }
                    
                } catch (error) {
                    console.error('请求错误:', error);
                    logDebug("发生错误", error.message);
                    
                    responseContainer.textContent = `发生错误: ${error.message}`;
                    statusDiv.textContent = '请求失败';
                    
                    // 处理CORS错误
                    if (error.message.includes('CORS') || error.message.includes('cross-origin')) {
                        responseContainer.innerHTML = `
                            <p>发生跨域请求错误 (CORS)。这是由于浏览器的安全策略导致的。</p>
                            <p>解决方案:</p>
                            <ol>
                                <li>尝试选择"使用CORS代理"选项</li>
                                <li>或者使用浏览器插件临时禁用CORS (仅用于测试)</li>
                                <li>或者部署自己的代理服务</li>
                            </ol>
                            <p><strong>技术详情:</strong> ${error.message}</p>
                        `;
                    }
                } finally {
                    // 恢复发送按钮
                    sendButton.disabled = false;
                }
            });
            
            // 初始化时触发一次选择事件，更新提示信息
            botSelect.dispatchEvent(new Event('change'));
        });
    </script>
</body>
</html>